# Adding New Workflows

This guide explains how to add new workflow automations to the Duramation platform.

## Quick Start Checklist

- [ ] Create workflow folder structure
- [ ] Define workflow metadata (FIRST - for types)
- [ ] Generate Zod schemas
- [ ] Register event type in client.ts (BEFORE function)
- [ ] Implement workflow function
- [ ] Export function
- [ ] Add workflow template to database
- [ ] Test workflow

## Step-by-Step Guide

### 1. Create Workflow Folder

Create a new folder under `src/inngest/functions/`:

```bash
mkdir -p src/inngest/functions/my-workflow
```

### 2. Create Metadata File (FIRST!)

**⚠️ IMPORTANT: Create metadata BEFORE the function file so types are available**

Create `src/inngest/functions/my-workflow/metadata.ts`:

```typescript
import { inngest } from "@/inngest/client";
import { NonRetriableError } from "inngest";
import { workflowChannel, createWorkflowUpdate } from "@/lib/realtime-channels";

export const myWorkflow = inngest.createFunction(
  {
    id: "my-workflow",
    idempotency: 'event.data.user_id + "-" + event.data.workflowId + "-" + event.data.idempotency_key',
    cancelOn: [{
      event: "workflow/stop",
      if: "async.data.workflowId == event.data.workflowId && async.data.user_id == event.data.user_id",
    }],
  },
  { event: "workflow/my.workflow" }, // ✅ TypeScript now knows this event type!
  async ({ step, event, logger, publish, credentials }) => {
    const { workflowId, user_id, input } = event.data;

    logger.info(`Running my workflow for user ${user_id}`);

    if (!input) {
      throw new NonRetriableError("Input is required");
    }

    // Check for required credentials
    const requiredCredential = credentials.find((cred: any) => cred.provider === 'GOOGLE');

    if (!requiredCredential) {
      await publish(
        workflowChannel(user_id, workflowId).updates(
          createWorkflowUpdate("log", "Error: Required credentials not found.")
        )
      );
      throw new NonRetriableError("Required credentials missing");
    }

    // Your workflow logic here
    await step.run("main-step", async () => {
      await publish(
        workflowChannel(user_id, workflowId).updates(
          createWorkflowUpdate("progress", "Processing...")
        )
      );

      // Do work here

      await publish(
        workflowChannel(user_id, workflowId).updates(
          createWorkflowUpdate("log", "Completed successfully")
        )
      );

      return { success: true };
    });

    logger.info(`Workflow completed for user ${user_id}`);
    return { success: true };
  }
);
```

### 6. Export Function

Add your function to `src/inngest/functions/index.ts`:

```typescript
import { z } from "zod";
import { Prisma, Provider } from '@duramation/db';
import {
  WorkflowInputFieldDefinition,
  WorkflowTemplate,
} from '@duramation/shared';

type JsonValue = Prisma.JsonValue;

// Field definitions
export const MyWorkflowFields: WorkflowInputFieldDefinition[] = [
  {
    key: 'inputField',
    label: 'Input Field',
    description: 'Description of the field',
    type: 'text',
    validation: {
      required: true,
      min: 1,
    },
  },
];

// Template definition
export const MyWorkflowTemplate: WorkflowTemplate = {
  id: 'my-workflow',
  name: 'My Workflow',
  description: 'Description of what this workflow does',
  eventName: 'workflow/my.workflow',
  canBeScheduled: true,
  requiredProviders: [Provider.GOOGLE],
  requiredScopes: {
    [Provider.GOOGLE]: [
      'https://www.googleapis.com/auth/userinfo.email',
    ],
  },
  restrictedToUsers: ['*'], // ['*'] = all users, or ['user_id1', 'user_id2'] for specific users
  fields: MyWorkflowFields as unknown as JsonValue,
  tags: ['automation', 'productivity'],
  version: '1.0.0',
};

// Zod schemas will be auto-generated by running: yarn update-schemas
```

### 3. Generate Zod Schemas

Run the schema generation script:

```bash
yarn update-schemas
```

This will automatically add Zod schemas to your metadata file:
- `WorkflowMyWorkflowInputSchema`
- `WorkflowMyWorkflowInput` type
- `WorkflowMyWorkflowEventSchema`
- `WorkflowMyWorkflowEvent` type

### 4. Register Event Type (BEFORE Creating Function!)

**⚠️ CRITICAL: Do this BEFORE creating the function file so TypeScript can resolve the event type**

Add your workflow event to `src/inngest/client.ts`:

```typescript
// Add import
import { WorkflowMyWorkflowInput } from '@/inngest/functions/my-workflow/metadata';

// Add to Events interface
export type Events = {
  // ... existing events
  'workflow/my.workflow': WorkflowTriggerPayload<WorkflowMyWorkflowInput>;
};

// Add to eventKeys array
const eventKeys = [
  // ... existing keys
  'workflow/my.workflow',
] as const;
```

### 5. Create Function File (NOW types are available!)

**Now that types are registered in client.ts, create the function:**

Create `src/inngest/functions/my-workflow/function.ts`:

```typescript
import { myWorkflow } from "./my-workflow/function";

export const workflowFunctions = [
  // ... existing functions
  myWorkflow,
];
```

### 7. Add Template to Database

Run the template sync script:

```bash
yarn add-templates
```

This will add your workflow template to the database.

### 8. Test Your Workflow

1. Start the development server
2. Navigate to the Marketplace
3. Install your workflow
4. Configure required credentials
5. Run the workflow and verify it works

## Field Types

Available field types for workflow inputs:

- `text` - Single line text input
- `textarea` - Multi-line text input
- `number` - Numeric input
- `boolean` - Checkbox
- `select` - Dropdown selection
- `multiselect` - Multiple selection
- `date` - Date picker
- `email` - Email input with validation
- `url` - URL input with validation
- `json` - JSON object input

## Validation Options

```typescript
validation: {
  required: true,      // Field is required
  min: 1,             // Minimum length/value
  max: 100,           // Maximum length/value
  options: ['a', 'b'] // Valid options for select fields
}
```

## Best Practices

### 1. Use Steps for Retryable Operations

```typescript
await step.run("api-call", async () => {
  // This will automatically retry on failure
  return await externalAPI.call();
});
```

### 2. Provide User Feedback

```typescript
await publish(
  workflowChannel(user_id, workflowId).updates(
    createWorkflowUpdate("progress", "Step 1 of 3 complete")
  )
);
```

### 3. Handle Errors Gracefully

```typescript
try {
  await riskyOperation();
} catch (error) {
  await publish(
    workflowChannel(user_id, workflowId).updates(
      createWorkflowUpdate("log", `Error: ${error.message}`)
    )
  );
  throw new NonRetriableError("Operation failed");
}
```

### 4. Validate Credentials Early

```typescript
const requiredCred = credentials.find(c => c.provider === 'GOOGLE');
if (!requiredCred) {
  throw new NonRetriableError("Google credentials required");
}
```

### 5. Use Idempotency Keys

The idempotency key is automatically generated per run to prevent duplicate executions.

## Troubleshooting

### Workflow not appearing in marketplace
- Run `yarn add-templates` to sync templates to database
- Check that `restrictedToUsers` includes your user ID or `['*']`

### Event type errors
- Ensure event is added to `client.ts` Events interface
- Ensure event is in the `eventKeys` array
- Restart the dev server after changes

### Credentials not available
- Verify `requiredProviders` in template metadata
- Check that credentials are properly associated with the workflow
- Ensure middleware is properly configured

## Next Steps

- See [INTEGRATION_BEST_PRACTICES.md](./INTEGRATION_BEST_PRACTICES.md) for service integration guidelines
- Check existing workflows in `src/inngest/functions/` for examples
- Review the [Inngest documentation](https://www.inngest.com/docs) for advanced features
