generator client {
  provider = "prisma-client-js"
  output   = "src/generated/client"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL") // uses connection pooling
  directUrl = env("POSTGRES_PRISMA_URL") // uses a direct connection
}

// --- Models ---
// Maps to the 'users' table
model User {
  id       String @id @default(cuid())
  clerk_id String @unique
  email    String @unique

  // Other user fields can go here, like name, password, etc.
  name String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  phone_number String? @unique /// @encrypted

  role String @default("user")

  // The user's preferred language, e.g., 'en', 'es', 'fr',
  language String @default("en")

  is_active Boolean @default(true)

  // A list of all workflows belonging to this user.
  workflows Workflow[]

  // A list of all credentials belonging to this user.
  credentials Credential[]

  // Workflow run history
  workflowRuns WorkflowRun[]

  // Client branding configuration
  clientBranding ClientBranding?

  // Service requests from this user
  serviceRequests ServiceRequest[]

  // API keys for external workflow triggering
  apiKeys ApiKey[]

  @@map("users")
}

enum CredentialType {
  OAUTH
  API_KEY
  // Add more general types here if needed
}

enum Provider {
  GOOGLE
  SLACK
  MICROSOFT
  HUBSPOT
  FIRECRAWL
  INSTAGRAM
  CUSTOM
}

enum WorkflowStatus {
  IDLE
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum RunStatus {
  STARTED
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

model Credential {
  id       String         @id @default(cuid())
  name     String // e.g., "Lab API Key" or "CRM Access"
  type     CredentialType
  provider Provider

  secret    String? /// @encrypted - Stored as encrypted JSON string
  config    Json? // optional extra data (endpoint, token expiry)
  expiresIn DateTime?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  // This is the new field to reference the join table.
  workflowCredentials WorkflowCredential[]

  @@unique([userId, name])
  @@index([userId])
  @@map("credentials")
}

// A workflow represents a user's entire configuration.
model Workflow {
  id   String @id @default(cuid())
  // The name of the workflow, must match the inngest function id
  name String

  templateId String

  // A short description of the workflow.
  description String?

  // Whether the workflow instance is available for use by the user
  available Boolean @default(true)

  // Current status of the workflow
  status WorkflowStatus @default(IDLE)

  canBeScheduled Boolean @default(false)

  idempotencyKey String? @default(cuid())

  cronExpressions String[]  @default([]) // Multiple schedules  e.g., ["0 9 * * *", "0 12 * * *"]
  timezone        String?   @default("UTC") // e.g., "America/New_York"
  lastRunAt       DateTime?
  nextRunAt       DateTime?

  fields Json?
  input  Json?

  // The name of the event or the cron value for the schedule eg. "TZ=Europe/Paris 0 12 * * 5"
  eventName String

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  // The foreign key linking this workflow to a specific user.
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  requiredProviders Provider[] @default([])
  requiredScopes    Json? // Stores scopes per provider as Record<Provider, string[]>

  version String? // Version of the workflow template used

  config Json?

  // This is the new field to reference the join table.
  workflowCredentials WorkflowCredential[]

  // Workflow run history
  workflowRuns WorkflowRun[]

  // Automation metrics for this workflow
  automationMetrics AutomationMetrics[]

  @@index([userId])
  @@map("workflows")
}

// This model acts as a join table for the many-to-many relationship
// between Workflow and Credential.
model WorkflowCredential {
  // Composite ID to uniquely identify the relationship
  workflowId   String
  credentialId String

  // Foreign keys linking to the Workflow and Credential models
  workflow   Workflow   @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  credential Credential @relation(fields: [credentialId], references: [id], onDelete: Cascade)

  @@id([workflowId, credentialId])
  @@map("workflow_credentials")
}

// Stores individual workflow run instances and their realtime data
model WorkflowRun {
  id String @id @default(cuid())

  // Inngest run ID for correlation
  inngestRunId String @unique

  idempotencyKey String? @unique

  // Status of this specific run
  status RunStatus @default(STARTED)

  // Timestamps
  startedAt   DateTime  @default(now())
  completedAt DateTime?

  // Run metadata
  input  Json? // Input parameters for this run
  output Json? // Final output/result
  error  String? // Error message if failed

  // Realtime data storage
  realtimeData Json[] @default([]) // Array of realtime messages/updates

  version String? // Version of the workflow template used

  // Foreign key to workflow
  workflowId String
  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  // Foreign key to user (denormalized for easier queries)
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index([workflowId])
  @@index([userId])
  @@index([inngestRunId])
  @@index([status])
  @@map("workflow_runs")
}

model WorkflowTemplate {
  id                String     @id
  name              String
  description       String
  eventName         String     @unique
  canBeScheduled    Boolean
  requiredProviders Provider[] @default([])
  requiredScopes    Json?
  fields            Json?
  restrictedToUsers String[]
  tags              String[]
  version           String

  @@map("workflow_templates")
}

// Client branding configuration for white-labeled dashboard
model ClientBranding {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  companyName    String
  logoUrl        String?
  primaryColor   String?
  secondaryColor String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("client_branding")
}

enum RequestPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum RequestStatus {
  SUBMITTED
  REVIEWED
  MEETING_SCHEDULED
  PROPOSAL_SENT
  APPROVED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// Service request tracking for new automation requests
model ServiceRequest {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  title           String
  description     String
  businessProcess String // Current manual process
  desiredOutcome  String // What they want to achieve
  priority        RequestPriority @default(MEDIUM)
  status          RequestStatus   @default(SUBMITTED)

  // Meeting scheduling
  meetingScheduled     Boolean   @default(false)
  meetingUrl           String?
  meetingDate          DateTime?
  preferredMeetingDate String? // New field for preferred meeting date
  availabilityNotes    String? // New field for availability notes

  // Proposal tracking
  proposalSent     Boolean  @default(false)
  proposalAccepted Boolean?
  estimatedHours   Int?
  quotedPrice      Decimal?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@map("service_requests")
}

// Performance metrics storage for ROI calculations
model AutomationMetrics {
  id         String   @id @default(cuid())
  workflowId String
  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  date         DateTime @db.Date
  runsCount    Int      @default(0)
  successCount Int      @default(0)
  failureCount Int      @default(0)
  avgDuration  Int? // milliseconds

  // ROI metrics
  timeSavedMinutes Int? // estimated time saved
  errorsPrevented  Int? // estimated errors prevented
  costSavings      Decimal? // calculated cost savings

  createdAt DateTime @default(now())

  @@unique([workflowId, date])
  @@index([workflowId])
  @@index([date])
  @@map("automation_metrics")
}

// API keys for external workflow triggering
model ApiKey {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name       String // User-friendly name for the key
  key        String    @unique /// @encrypted - The actual API key (hashed)
  lastUsedAt DateTime?
  expiresAt  DateTime? // Optional expiration
  isActive   Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([key])
  @@map("api_keys")
}
